# 汎用タスク実行 AI エージェント（General AI Agent）

ブラウザから自然言語で指示すると、

- 手元の文書（契約書など）をもとにした **RAG 検索**
- 外部 Web を使った **Web検索（Tavily）**
- それらを使わない **LLM 単体の一般回答**

を、自動で組み合わせて回答する **エージェント型 Web アプリケーション** です。

単なる「チャットボット」ではなく、

- 文書アップロード＆インデックス構築
- 文書一覧・削除
- Web検索と RAG の併用
- エージェントのステップログ表示

までを一通り備えた「汎用タスク実行エージェント」の最小構成を目指しています。

---

## 1. 特徴

### 🧠 意図解析（Intent Routing）

入力された質問から、エージェントがざっくりと以下を判定します。

- 「手元の文書に依拠すべきか」（doc_dependent）
- 「Webで最新情報を取りに行くべきか」（web_required）
- 「通常の一般知識だけで足りるか」（llm_only）
- またはその組み合わせ（例：doc＋Web）

この判定結果に応じて、RAG / Web / LLM を柔軟に使い分けます。

---

### 📄 文書登録 & RAG 連携

RAG 対象の文書は、以下の 2 通りの方法で登録できます。

1. **画面上にコピペして登録**

   - タイトルと本文（全文）を入力 → `/api/documents/register` でインデックスに登録
   - NDA / 業務委託契約 / 雇用契約 など、テキストベースの契約書を想定

2. **ファイルをアップロードして登録**

   - 対応形式：
     - `.txt` / `.md` / `.markdown` / `.json`（UTF-8テキスト）
     - `.pdf`（テキスト埋め込み型）
     - `.docx`（Wordファイル）
   - `/api/documents/upload` 経由でテキスト抽出 → Chroma にチャンクとして保存

登録された文書は、Chroma ベースのベクターストアにチャンク分割・埋め込みされ、
LangGraph の RAG ノードから検索されます。

---

### 📚 文書一覧・削除

登録済み文書は以下の UI から確認できます。

- タイトル
- document_id
- チャンク数

不要になった文書は、**document_id 単位で一括削除**できます。  
これにより「検証用にどんどん投げて、要らなくなったら削除」という運用が可能です。

---

### 🌐 Web 検索連携（Tavily）

Web参照が必要と判断された質問に対しては、Tavily API を使って検索し、  
取得した外部コンテキスト（検索結果サマリ）も LLM に渡します。

- ニュース・相場・法改正など、**手元文書には存在しない最新情報**を補完する用途を想定
- RAGと Web の両方が有効な場合は、**手元文書の情報を優先しつつ、外部情報を参考として付加**するプロンプト設計にしています。

---

### 🧾 思考ログの可視化

エージェントの各ステップ（例）

- `analysis` : 質問意図解析（文書依存か / Web必要か / LLMのみか）
- `rag`      : RAG 実行＆ヒット件数のログ
- `web`      : Web検索実行＆簡易サマリ
- `answer`   : 最終回答生成

を、フロント側の「実行ログ」エリアにリスト表示します。

どのステップが実行されたかが分かるので、

- 「なぜ手元文書が参照されなかったか」
- 「なぜ Web が呼ばれたのか」

などの挙動が追いやすくなっています。

---

### 💻 Web アプリとして利用可能

- フロントエンド：React（Vite）
- バックエンド：FastAPI + LangGraph

ブラウザからアクセスするだけで、

1. 文書登録（コピペ / ファイル）
2. 質問入力
3. 回答＋実行ログ確認

まで完結します。

---

## 2. アーキテクチャ

```text
User (Browser)
   ↓
React Frontend
   ├─ 文書登録（POST /api/documents/register）
   ├─ ファイルアップロード（POST /api/documents/upload）
   ├─ 文書一覧取得（GET /api/documents）
   ├─ 文書削除（DELETE /api/documents/{document_id}）
   └─ 質問送信（POST /api/agent/ask）

FastAPI Backend
   ↓
LangGraph エージェント
   ├─ ノード1: 質問意図解析 (analysis)
   │      └─ doc_dependent / web_required / llm_only / both を判定
   ├─ ノード2: RAG 実行 (rag)
   │      └─ Chroma（documents コレクション）からベクトル検索
   ├─ ノード3: Web検索 (web)
   │      └─ Tavily API で外部Web情報を取得
   └─ ノード4: 回答生成 (answer)
          └─ OpenAI Chat モデルに
              「質問 + 会話履歴 + RAG結果 + Web結果」を渡して回答生成

応答JSON: { output, steps[] } をフロントに返却
